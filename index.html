<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>üéÑ MA EK MO ‚Äî Jeu de grattage</title>

  <style>
    body {
      margin:0;
      padding:0;
      font-family:'Poppins', sans-serif;
      background:url('Prix2.PNG') center/cover no-repeat fixed;
      display:flex;
      justify-content:center;
      align-items:center;
      height:100vh;
    }

    .container {
      background: rgba(255, 255, 255, 0.75); /* blanc translucide */
      border-radius: 20px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
      padding: 20px;
      max-width: 400px;
      text-align: center;
      position: relative;
    }

    h1 {
      font-size: 1.4em;
      margin-bottom: 5px;
    }

    .video {
       width:150px;
      border-radius:10px;
    }

    #scratchCard {
      position: relative;
      width: 300px;
      height: 200px;
      margin: 20px auto;
      background-color: transparent;
      border-radius: 10px;
      overflow: hidden;
    }

    canvas {
      position: absolute;
      top: 0;
      left: 0;
      cursor: crosshair;
      border-radius: 10px;
    }

    #result {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 1.3em;
      font-weight: bold;
      color: black;
      z-index: 1;
      text-align: center;
      width: 100%;
    }

    #adminPanel {
            background:gold;
      color:black;
      border:none;
      padding:8px 12px;
      border-radius:8px;
      cursor:pointer;
      font-weight:bold;
      margin-top:15px;
    }

    input[type="password"] {
      padding: 5px;
      border-radius: 5px;
      border: 1px solid #aaa;
    }

    button {
      background-color: #e0b94f;
      color: black;
      border: none;
      padding: 8px 15px;
      margin-top: 10px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: bold;
    }

    @media (max-width: 600px) {
      .container{ width:95%; }
      video{ width:120px; }
      canvas{ width:260px; height:140px; }
      .result{ width:260px; height:140px; }
    
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>MA EK MO ‚Äî Rhums arrang√©s & punchs</h1>
    <p id="playerNumber">Joueur n¬∞...</p>

    <div id="scratchCard">
      <div id="result"></div>
      <canvas id="scratchCanvas" width="300" height="200"></canvas>
    </div>

        <div class="video-container">
      <video id="bouchon-video" src="bouchon2.mp4" muted loop></video>
    </div>

    <div id="adminPanel">
      <input type="password" id="adminPass" placeholder="Mot de passe admin" />
      <button onclick="resetGame()">R√©initialiser</button>
    </div>
  </div>

  <!-- üìß EmailJS SDK -->
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
  <script>
    (function() {
      emailjs.init("1P7PupUaqiHbW50OZ"); // ton user_id
    })();
  </script>

  <!-- üî• Firebase + jeu -->
  <script type="module">
    // Import Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAZcpcC_7l6wYN4SJUGa9dBbEa_ekV1n20",
      authDomain: "ma-ek-mo-grattage.firebaseapp.com",
      projectId: "ma-ek-mo-grattage",
      storageBucket: "ma-ek-mo-grattage.firebasestorage.app",
      messagingSenderId: "478221366203",
      appId: "1:478221366203:web:ffb64fe9cbb7dc0aa20a9e",
      measurementId: "G-BZSKRGV3PS"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const resultDiv = document.getElementById("result");
    const canvas = document.getElementById("scratchCanvas");
    const ctx = canvas.getContext("2d");
    const video = document.getElementById("bouchonVideo");
    const playerNumber = document.getElementById("playerNumber");

    let playerIndex = localStorage.getItem("playerIndex");
    let hasPlayed = localStorage.getItem("hasPlayed") === "true";
    let revealed = false;

    async function getNextPlayerNumber() {
      const snapshot = await getDocs(collection(db, "joueurs"));
      return snapshot.size + 1;
    }

    async function setup() {
      if (!playerIndex) {
        playerIndex = await getNextPlayerNumber();
        localStorage.setItem("playerIndex", playerIndex);
      }
      playerNumber.textContent = "Joueur n¬∞" + playerIndex;

      const result = localStorage.getItem("resultat");
      if (result) {
        showResult(result);
        return;
      }

      // Zone dor√©e
      ctx.fillStyle = "#d4af37";
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      ctx.globalCompositeOperation = "destination-out";
      canvas.addEventListener("mousedown", startScratching);
      canvas.addEventListener("touchstart", startScratching);
    }

    function startScratching(e) {
      if (hasPlayed) return;
      revealed = false;
      canvas.addEventListener("mousemove", scratch);
      canvas.addEventListener("touchmove", scratch);
      canvas.addEventListener("mouseup", reveal);
      canvas.addEventListener("touchend", reveal);
    }

    function scratch(e) {
      e.preventDefault();
      const rect = canvas.getBoundingClientRect();
      const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
      const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
      ctx.beginPath();
      ctx.arc(x, y, 15, 0, 2 * Math.PI);
      ctx.fill();
    }

    async function reveal() {
      if (revealed || hasPlayed) return;
      revealed = true;
      hasPlayed = true;
      localStorage.setItem("hasPlayed", "true");

      // Gagnants al√©atoires (5 sur 200)
      const isWinner = Math.random() < 5 / 200;
      const choice = isWinner
        ? "üéâ F√©licitations tu as gagn√© !"
        : "üëèüèæ Bravo tu obtiens une r√©duction de -10% d√®s 30‚Ç¨ d'achat.";

      resultDiv.textContent = choice;

      // Stocke le r√©sultat localement
      localStorage.setItem("resultat", choice);

      // D√©marre la vid√©o
      video.style.display = "block";
      video.play();

      // Sauvegarde dans Firestore
      await addDoc(collection(db, "joueurs"), {
        numero: playerIndex,
        resultat: choice,
        date: new Date().toISOString(),
      });

      // Envoi d'email avec EmailJS
      emailjs
        .send("service_cqjooc5", "template_ct2ucqj", {
          to_name: "Admin MA EK MO",
          message: `Le joueur n¬∞${playerIndex} a jou√©.\nR√©sultat : ${choice}`,
          reply_to: "contact@maekmo.com",
        })
        .then(() => console.log("‚úÖ Email envoy√©"))
        .catch((err) => console.error("‚ùå Erreur EmailJS :", err));

      // D√©sactive le grattage
      canvas.removeEventListener("mousemove", scratch);
      canvas.removeEventListener("touchmove", scratch);
    }

    window.resetGame = () => {
      const pass = document.getElementById("adminPass").value;
      if (pass === "maekmo2025") {
        localStorage.clear();
        alert("‚úÖ Jeu r√©initialis√© !");
        location.reload();
      } else {
        alert("‚ùå Mot de passe incorrect !");
      }
    };

    setup();
  </script>
</body>
</html>
