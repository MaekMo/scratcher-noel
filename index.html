<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Grattage ‚Äî No√´l sous les tropiques</title>
<style>
  :root{
    --bg1:#ffefba; /* sand */
    --bg2:#fff1c9; /* light sand */
    --accent:#ff6b6b; /* festive red */
    --accent2:#00b5ad; /* turquoise */
    --card:#fffdf8;
    --text-dark:#1b2b2b;
  }
  html,body{height:100%;margin:0;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background: linear-gradient(180deg,var(--bg1),var(--bg2)); color:var(--text-dark);}
  .scene{
    min-height:100vh;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:24px;
    box-sizing:border-box;
    background-image:
      radial-gradient(circle at 20% 10%, rgba(255,255,255,0.15), transparent 20%),
      linear-gradient(180deg, rgba(255,250,230,0.6), rgba(255,245,230,0.9));
  }

  .card{
    width:360px;
    max-width:95%;
    background:linear-gradient(180deg, rgba(255,255,255,0.95), rgba(255,255,255,0.98));
    border-radius:18px;
    box-shadow: 0 8px 30px rgba(0,0,0,0.12);
    padding:18px;
    text-align:center;
    position:relative;
    overflow:hidden;
  }

  .header{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    margin-bottom:10px;
  }
  .logo{
    display:flex;align-items:center;gap:10px;
  }
  .logo .title{font-weight:700;font-size:18px}
  .subtitle{font-size:12px;color:#6b6b6b}

  .beach-illustration{
    height:100px; border-radius:12px; margin:8px 0 14px;
    background: linear-gradient(180deg,#7ee0ff 0%, #a3f7d1 60%, #fff9d6 100%);
    position:relative;
    overflow:hidden;
  }
  .sun{position:absolute;right:18px;top:8px;font-size:36px; transform: rotate(-10deg);}
  .palm{position:absolute;left:6px;bottom:-10px;font-size:60px; transform: rotate(-6deg); opacity:0.95}
  .rum{position:absolute;right:20px;bottom:6px;font-size:28px}

  .ticket{
    margin:0 auto 12px; width:100%; max-width:320px; background:linear-gradient(180deg,#fffdfa,#fff5ef); border-radius:12px; padding:12px; box-shadow: 0 6px 18px rgba(0,0,0,0.08);
  }
  .ticket .info{font-weight:600;color:var(--accent2); margin-bottom:6px}
  .scratch-area{
    position:relative; height:120px; border-radius:8px; overflow:hidden; background:
      linear-gradient(135deg, rgba(255,255,255,0.02), rgba(0,0,0,0.02));
    display:flex; align-items:center; justify-content:center;
  }
  .prize-text{
    font-size:18px; font-weight:700; position:absolute; z-index:1; text-align:center; padding:8px;
  }

  /* canvas overlay */
  canvas#scratchCanvas{ position:absolute; inset:0; z-index:2; }

  .controls{display:flex; gap:8px; justify-content:center; margin-top:10px}
  button{cursor:pointer;border:0;padding:10px 12px;border-radius:10px;font-weight:600;background:linear-gradient(180deg,#fff,#f6f6f6); box-shadow:0 4px 10px rgba(0,0,0,0.06)}
  .cta{background:linear-gradient(180deg,var(--accent),#ff4b4b); color:white; box-shadow: 0 6px 18px rgba(255,75,75,0.18)}
  .muted{font-size:12px;color:#6c6c6c;margin-top:8px}

  .admin-bar{margin-top:12px;border-top:1px dashed rgba(0,0,0,0.06);padding-top:10px;display:flex;gap:8px;align-items:center;justify-content:center}
  .admin-input{padding:8px;border-radius:8px;border:1px solid #eee}

  .footer{font-size:12px;color:#6b6b6b;margin-top:14px}
  .sparkle{position:absolute;left:10px;top:8px;font-size:20px;opacity:0.9}

  /* responsive */
  @media (max-width:380px){ .card{padding:14px} .ticket{padding:10px} .prize-text{font-size:16px} }
</style>
</head>
<body>
<div class="scene">
  <div class="card" role="main" aria-label="Jeu de grattage No√´l tropical">
    <div class="header">
      <div class="logo">
        <div style="font-size:28px">üå¥üéÑ</div>
        <div>
          <div class="title">No√´l sous les tropiques</div>
          <div class="subtitle">Gratte et d√©couvre ton sort... (1 partie / appareil)</div>
        </div>
      </div>
      <div class="sparkle">‚ú®</div>
    </div>

    <div class="beach-illustration" aria-hidden="true">
      <div class="sun">‚òÄÔ∏è</div>
      <div class="palm">üå¥</div>
      <div class="rum">üçπ</div>
    </div>

    <div class="ticket">
      <div class="info">Ticket myst√®re ‚Äî 200 tickets ¬∑ 5 gagnants</div>

      <div class="scratch-area" id="scratchCard">
        <div class="prize-text" id="prizeText">Gratte ici</div>
        <canvas id="scratchCanvas"></canvas>
      </div>

      <div class="controls">
        <button id="revealBtn" class="cta">R√©v√©ler</button>
        <button id="helpBtn">Comment gratter ?</button>
      </div>

      <div class="muted" id="statusText"></div>

      <div class="admin-bar" id="adminBar">
        <input id="adminPwd" class="admin-input" placeholder="Mot de passe admin" type="password" />
        <button id="adminBtn">Entrer (admin)</button>
      </div>

      <div id="adminPanel" style="display:none; margin-top:10px;">
        <div style="display:flex; gap:8px; justify-content:center; margin-bottom:8px;">
          <button id="regenPool">Reg√©n√©rer la pool</button>
          <button id="resetAll">R√©initialiser tout (tests)</button>
        </div>
        <div style="font-size:12px;color:#555">Utilise ces outils avec pr√©caution. La reg√©n√©ration red√©finit al√©atoirement les 5 tickets gagnants pour ce navigateur.</div>
      </div>

    </div>

    <div class="footer">
      <div id="infoAdmin" style="margin-bottom:6px">Admin: mot de passe requis pour autoriser √† rejouer / r√©g√©n√©rer.</div>
      <div>Design : No√´l tropical ‚Äî palmiers, plage, rhum & soleil üåûüçπ</div>
    </div>
  </div>
</div>

<script>
/* ========== CONFIG ========== */
const TOTAL_TICKETS = 200;   // nombre total de tickets
const TOTAL_WINNERS = 5;     // nombre total de gagnants
let ADMIN_PASSWORD = 'NoelTropical2025'; // change ici si tu veux (ou √©dite apr√®s d√©ploiement)

/* clefs localStorage */
const STORAGE_POOL_KEY = 'scratcher_pool_v1';
const STORAGE_PLAYED_KEY = 'scratcher_played_v1';
/* ============================ */

/* utilitaires */
function randInt(n){ return Math.floor(Math.random()*n); }

/* pool management:
   pool is array length TOTAL_TICKETS
   values:
     0 = lose (non utilis√©)
     1 = win (non utilis√©)
     2 = used lose
     3 = used win
*/
function createPool(){
  const arr = new Array(TOTAL_TICKETS).fill(0);
  // choose TOTAL_WINNERS unique indices
  let chosen = new Set();
  while(chosen.size < TOTAL_WINNERS){
    chosen.add(randInt(TOTAL_TICKETS));
  }
  chosen.forEach(i => arr[i] = 1);
  localStorage.setItem(STORAGE_POOL_KEY, JSON.stringify(arr));
  return arr;
}
function loadPool(){
  const raw = localStorage.getItem(STORAGE_POOL_KEY);
  if(!raw) return createPool();
  try{
    const arr = JSON.parse(raw);
    if(!Array.isArray(arr) || arr.length !== TOTAL_TICKETS) return createPool();
    return arr;
  }catch(e){ return createPool(); }
}
function savePool(pool){ localStorage.setItem(STORAGE_POOL_KEY, JSON.stringify(pool)); }

function getUnusedTicketIndex(pool){
  const unused = [];
  for(let i=0;i<pool.length;i++){
    if(pool[i] === 0 || pool[i] === 1) unused.push(i);
  }
  if(unused.length===0) return -1;
  return unused[randInt(unused.length)];
}

/* admin check (simple) */
function checkAdmin(pwd){ return pwd === ADMIN_PASSWORD; }

/* UI & scratch logic */
const canvas = document.getElementById('scratchCanvas');
const scratchArea = document.getElementById('scratchCard');
const prizeTextEl = document.getElementById('prizeText');
const revealBtn = document.getElementById('revealBtn');
const helpBtn = document.getElementById('helpBtn');
const statusText = document.getElementById('statusText');
const adminBtn = document.getElementById('adminBtn');
const adminPwd = document.getElementById('adminPwd');
const adminPanel = document.getElementById('adminPanel');
const regenPoolBtn = document.getElementById('regenPool');
const resetAllBtn = document.getElementById('resetAll');

let ctx, isDrawing=false, lastPos={x:0,y:0};
let pool = loadPool();
let chosenTicketIndex = null;
let chosenTicketStatus = null; // 0/1/2/3

function resizeCanvas(){
  const rect = scratchArea.getBoundingClientRect();
  canvas.width = rect.width;
  canvas.height = rect.height;
  drawOverlay();
}
function drawOverlay(){
  if(!ctx) return;
  // silver scratch overlay
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle = '#B4B4B4';
  ctx.fillRect(0,0,canvas.width,canvas.height);
  // subtle noise effect using globalAlpha rectangles
  ctx.globalAlpha = 0.06;
  for(let i=0;i<200;i++){
    ctx.fillRect(Math.random()*canvas.width, Math.random()*canvas.height, Math.random()*8+1, Math.random()*8+1);
  }
  ctx.globalAlpha = 1;
  // add subtle diagonal shine
  const g = ctx.createLinearGradient(0,0, canvas.width, canvas.height);
  g.addColorStop(0,'rgba(255,255,255,0.06)');
  g.addColorStop(1,'rgba(255,255,255,0)');
  ctx.fillStyle = g;
  ctx.fillRect(0,0,canvas.width,canvas.height);
  // set composite
  ctx.globalCompositeOperation = 'destination-out';
}
function pointerPos(e){
  const rect = canvas.getBoundingClientRect();
  const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
  const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
  return {x,y};
}
function startDraw(e){
  if(isPlayed()) return;
  isDrawing = true;
  lastPos = pointerPos(e);
  drawPoint(lastPos.x, lastPos.y);
  e.preventDefault();
}
function moveDraw(e){
  if(!isDrawing) return;
  const p = pointerPos(e);
  ctx.lineWidth = Math.max(canvas.width, canvas.height) * 0.06; // large brush
  ctx.lineCap = 'round';
  ctx.beginPath();
  ctx.moveTo(lastPos.x, lastPos.y);
  ctx.lineTo(p.x, p.y);
  ctx.stroke();
  lastPos = p;
  e.preventDefault();
  if(getScratchedPercentage() > 0.60) finishReveal();
}
function endDraw(e){
  isDrawing = false;
  e.preventDefault();
}
function drawPoint(x,y){
  ctx.beginPath();
  ctx.arc(x,y, Math.max(canvas.width, canvas.height)*0.03, 0, Math.PI*2);
  ctx.fill();
}
function getScratchedPercentage(){
  const img = ctx.getImageData(0,0,canvas.width,canvas.height);
  const pixels = img.data;
  let clear = 0;
  for(let i=3;i<pixels.length;i+=4){
    if(pixels[i] === 0) clear++;
  }
  const total = canvas.width * canvas.height;
  return clear/total;
}

function revealImmediate(){ // reveal without scratching
  if(isPlayed()) return;
  finishReveal();
}

function finishReveal(){
  if(isPlayed()) return;
  // mark as played
  markPlayed(true);

  // choose a ticket index from unused pool
  pool = loadPool();
  const idx = getUnusedTicketIndex(pool);
  if(idx === -1){
    // pool exhausted
    chosenTicketStatus = 0;
    prizeTextEl.textContent = 'Plus de tickets disponibles';
    statusText.textContent = 'La pool est √©puis√©e. Contacte l‚Äôadmin.';
    return;
  }
  chosenTicketIndex = idx;
  const isWin = pool[idx] === 1;

  // mark used
  pool[idx] = isWin ? 3 : 2;
  savePool(pool);

  // show message
  if(isWin){
    prizeTextEl.textContent = 'üéâ F√©licitations tu as gagn√©';
    statusText.textContent = `Ticket #${idx+1} ‚Äî Gagnant !`;
  }else{
    prizeTextEl.textContent = 'üò¢ Dommage tu as perdu';
    statusText.textContent = `Ticket #${idx+1} ‚Äî Essaye une autre fois (si autoris√©).`;
  }

  // fully clear the overlay to show result
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.globalCompositeOperation = 'source-over';
  // draw a subtle confetti for win
  if(isWin){
    // small confetti circles
    for(let i=0;i<28;i++){
      ctx.beginPath();
      ctx.fillStyle = ['#ff6b6b','#ffd166','#06d6a0','#118ab2'][i%4];
      ctx.arc(Math.random()*canvas.width, Math.random()*canvas.height, Math.random()*6+2,0,Math.PI*2);
      ctx.fill();
    }
  }
}

/* played flag */
function isPlayed(){ return localStorage.getItem(STORAGE_PLAYED_KEY) === '1'; }
function markPlayed(v){
  if(v) localStorage.setItem(STORAGE_PLAYED_KEY,'1');
  else localStorage.removeItem(STORAGE_PLAYED_KEY);
  updateUI();
}

/* UI update */
function updateUI(){
  if(isPlayed()){
    revealBtn.disabled = true;
    statusText.style.opacity = 1;
    const poolNow = loadPool();
    const winnersLeft = poolNow.filter(x => x === 1).length;
    document.getElementById('infoAdmin').textContent = `Gagnants restants (pour ce navigateur) : ${winnersLeft}`;
  }else{
    revealBtn.disabled = false;
    document.getElementById('infoAdmin').textContent = 'Admin: mot de passe requis pour autoriser √† rejouer / r√©g√©n√©rer.';
  }
}

/* admin actions */
adminBtn.addEventListener('click', () => {
  const val = adminPwd.value || '';
  if(checkAdmin(val)){
    adminPanel.style.display = 'block';
    adminPwd.value = '';
    statusText.textContent = 'Mode admin activ√© (actions pour ce navigateur).';
  }else{
    alert('Mot de passe admin incorrect.');
  }
});

regenPoolBtn.addEventListener('click', () => {
  if(!confirm('Reg√©n√©rer la pool va red√©finir al√©atoirement les tickets gagnants pour CE navigateur. Continuer ?')) return;
  pool = createPool();
  markPlayed(false);
  drawOverlay();
  statusText.textContent = 'Pool reg√©n√©r√©e.';
  updateUI();
});

resetAllBtn.addEventListener('click', () => {
  if(!confirm('R√©initialiser tout supprimera les donn√©es (pool + played) pour CE navigateur. Continuer ?')) return;
  localStorage.removeItem(STORAGE_POOL_KEY);
  localStorage.removeItem(STORAGE_PLAYED_KEY);
  pool = loadPool();
  drawOverlay();
  statusText.textContent = 'R√©initialis√©.';
  updateUI();
});

/* events */
window.addEventListener('resize', resizeCanvas);
window.addEventListener('load', () => {
  ctx = canvas.getContext('2d', { willReadFrequently: true });
  resizeCanvas();
  pool = loadPool();
  // initial text
  prizeTextEl.textContent = isPlayed() ? 'Merci d\'avoir jou√©' : 'Gratte ici';
  updateUI();
});

/* pointer events for canvas */
canvas.addEventListener('mousedown', startDraw);
canvas.addEventListener('touchstart', startDraw, {passive:false});
window.addEventListener('mousemove', moveDraw);
window.addEventListener('touchmove', moveDraw, {passive:false});
window.addEventListener('mouseup', endDraw);
window.addEventListener('touchend', endDraw);

/* reveal button */
revealBtn.addEventListener('click', () => {
  if(confirm('Voulez-vous r√©v√©ler le ticket maintenant ?')) revealImmediate();
});

/* help */
helpBtn.addEventListener('click', () => alert('Gratte la zone grise avec la souris ou ton doigt. Quand une grande partie est gratt√©e, le r√©sultat s‚Äôaffichera.'));

/* scratch overlay draw initial stroke settings */
function initCanvasDrawing(){
  if(!ctx) return;
  ctx.globalCompositeOperation = 'destination-out';
  ctx.lineWidth = Math.max(canvas.width, canvas.height) * 0.06;
  ctx.lineCap = 'round';
  ctx.strokeStyle = 'rgba(0,0,0,1)';
}
setTimeout(initCanvasDrawing, 120);

/* protect replay: player can only replay if admin resets played flag on their device.
   Provide a small global keyboard shortcut for admin quick access: ctrl+shift+a opens admin input.
*/
window.addEventListener('keydown', (e) => {
  if(e.ctrlKey && e.shiftKey && e.key.toLowerCase() === 'a'){
    adminPwd.focus();
  }
});

/* initial draw overlay after small delay */
setTimeout(() => {
  if(ctx){
    ctx.globalCompositeOperation = 'destination-out';
    drawOverlay();
  }
}, 150);

</script>
</body>
</html>
