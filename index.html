<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MA EK MO ‚Äì Jeu de grattage</title>

  <style>
    body {
      margin:0;
      padding:0;
      font-family:'Poppins', sans-serif;
      background:url('Prix2.PNG') center/cover no-repeat fixed;
      display:flex;
      justify-content:center;
      align-items:center;
      height:100vh;
    }

    .container {
      background:rgba(255,255,255,0.75);
      border-radius:20px;
      padding:20px;
      width:90%;
      max-width:420px;
      text-align:center;
      backdrop-filter:blur(4px);
      box-shadow:0 0 12px rgba(255,215,0,0.6);
    }

    h1, #player-number {
      color:#000;
      font-weight:600;
    }

    canvas {
      width:300px;
      height:160px;
      border-radius:14px;
      margin-top:10px;
      cursor:pointer;
      box-shadow:0 0 10px rgba(255,215,0,0.8);
    }

    .video-container {
      margin:10px 0;
    }
    video {
      width:180px;
      border-radius:10px;
    }

    .result {
      color:#000;
      position:absolute;
      width:300px;
      height:160px;
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
      font-size:1.1em;
      font-weight:700;
      pointer-events:none;
      top:0;
      left:50%;
      transform:translateX(-50%);
      padding:10px;
      opacity:0;
      transition:opacity 1.2s ease-in-out;
    }

    .result.visible {
      opacity:1;
    }

    .admin button {
      background:gold;
      color:black;
      border:none;
      padding:8px 12px;
      border-radius:8px;
      cursor:pointer;
      font-weight:bold;
      margin-top:15px;
    }

    /* ---- PAGE D‚ÄôACCUEIL ---- */
    #payment-section {
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      text-align:center;
    }

    #qr-container img {
      border-radius:10px;
      box-shadow:0 0 8px rgba(0,0,0,0.2);
    }

    @media(max-width:600px){
      .container{ width:95%; }
      video{ width:140px; }
      canvas{ width:260px; height:140px; }
      .result{ width:260px; height:140px; }
    }
  </style>
</head>

<body>

  <div class="container" id="payment-container">
    <h1>MA EK MO ‚Äî Rhums arrang√©s & punchs</h1>
    <h2>Paiement du jeu (2‚Ç¨)</h2>

    <div id="payment-section">
      <button id="wero-btn"
        style="background-color:#28a745;color:white;padding:10px 20px;border:none;border-radius:10px;cursor:pointer;font-size:1em;font-weight:bold;">
        üí∏ Payer par Wero (2‚Ç¨)
      </button>

      <div id="qr-container" class="hidden" style="display:none; margin-top:20px;">
        <p>üì± Scanne ce QR code avec ton application bancaire Wero :</p>
        <img src="qrcode-wero.png" alt="QR Wero" width="180"/>
      </div>

      <button id="already-paid-btn"
        style="margin-top:20px;background-color:#f0ad4e;color:white;padding:10px 20px;border:none;border-radius:10px;cursor:pointer;font-size:1em;font-weight:bold;">
        ‚úÖ J‚Äôai d√©j√† pay√©
      </button>
    </div>
  </div>

  <div class="container" id="game-container" style="display:none;">
    <h1>MA EK MO ‚Äî Rhums arrang√©s & punchs</h1>
    <p id="player-number">Chargement...</p>

    <div class="video-container">
      <video id="bouchon-video" src="bouchon2.mp4" muted loop></video>
    </div>

    <div style="position:relative; display:inline-block;">
      <div id="result" class="result"></div>
      <canvas id="scratch-card" width="300" height="160"></canvas>
    </div>

    <div class="admin">
      <button id="reset-btn">üîí R√©initialiser le jeu</button>
    </div>
  </div>

  <!-- üìß EmailJS SDK -->
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
  <script>
    (function() {
      emailjs.init("1P7PupUaqiHbW50OZ");
    })();
  </script>

  <!-- üî• Firebase + Jeu -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAZcpcC_7l6wYN4SJUGa9dBbEa_ekV1n20",
      authDomain: "ma-ek-mo-grattage.firebaseapp.com",
      projectId: "ma-ek-mo-grattage",
      storageBucket: "ma-ek-mo-grattage.firebasestorage.app",
      messagingSenderId: "478221366203",
      appId: "1:478221366203:web:ffb64fe9cbb7dc0aa20a9e",
      measurementId: "G-BZSKRGV3PS"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const paymentContainer = document.getElementById("payment-container");
    const gameContainer = document.getElementById("game-container");
    const weroBtn = document.getElementById("wero-btn");
    const alreadyPaidBtn = document.getElementById("already-paid-btn");
    const qrContainer = document.getElementById("qr-container");
    const canvas = document.getElementById("scratch-card");
    const ctx = canvas.getContext("2d");
    const resultDiv = document.getElementById("result");
    const video = document.getElementById("bouchon-video");
    const playerNumber = document.getElementById("player-number");

    let playerIndex = localStorage.getItem("playerIndex");
    let hasPlayed = localStorage.getItem("hasPlayed") === "true";
    let revealed = false;

    // Lien deeplink Wero
    const weroLink = "wero://pay?iban=FR3420041010180247172N01586&amount=2.00&name=MA%20EK%20MO&message=Jeu%20de%20grattage";
    const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

    weroBtn.addEventListener("click", () => {
      if (isMobile) {
        window.location.href = weroLink;
        setTimeout(() => alert("Si ton application bancaire ne s‚Äôest pas ouverte, v√©rifie que Wero est install√©e."), 2000);
      } else {
        qrContainer.style.display = "block";
      }
    });

    alreadyPaidBtn.addEventListener("click", () => {
      const code = prompt("Entrez le code re√ßu apr√®s paiement ou laissez vide si confirm√© par l‚Äôadmin :");
      if (code !== null) {
        localStorage.setItem("accessGranted", "true");
        paymentContainer.style.display = "none";
        gameContainer.style.display = "block";
        setup();
      }
    });

    async function getNextPlayerNumber() {
      const snapshot = await getDocs(collection(db, "joueurs"));
      return snapshot.size + 1;
    }

    async function setup() {
      if (!playerIndex) {
        playerIndex = await getNextPlayerNumber();
        localStorage.setItem("playerIndex", playerIndex);
      }
      playerNumber.textContent = "Joueur n¬∞" + playerIndex;

      const result = localStorage.getItem("resultat");
      if (result) {
        showResult(result);
        return;
      }

      ctx.fillStyle = "#d4af37";
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      ctx.globalCompositeOperation = "destination-out";

      canvas.addEventListener("mousedown", startScratching);
      canvas.addEventListener("touchstart", startScratching);
    }

    function startScratching(e) {
      if (hasPlayed) return;
      revealed = false;
      canvas.addEventListener("mousemove", scratch);
      canvas.addEventListener("touchmove", scratch);
      canvas.addEventListener("mouseup", reveal);
      canvas.addEventListener("touchend", reveal);
    }

    function scratch(e) {
      e.preventDefault();
      const rect = canvas.getBoundingClientRect();
      const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
      const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
      ctx.beginPath();
      ctx.arc(x, y, 15, 0, 2 * Math.PI);
      ctx.fill();
    }

    async function reveal() {
      if (revealed || hasPlayed) return;
      revealed = true;
      hasPlayed = true;
      localStorage.setItem("hasPlayed", "true");

      const isWinner = Math.random() < 5 / 200;
      const choice = isWinner
        ? "üéâ F√©licitations tu as gagn√© !"
        : "üëèüèæ Bravo tu obtiens une r√©duction de -10% d√®s 30‚Ç¨ d'achat.";

      resultDiv.textContent = choice;
      resultDiv.classList.add("visible");

      localStorage.setItem("resultat", choice);
      video.style.display = "block";
      video.play();

      await addDoc(collection(db, "joueurs"), {
        numero: playerIndex,
        resultat: choice,
        date: new Date().toISOString(),
      });

      emailjs.send("service_cqjooc5", "template_ct2ucqj", {
        to_name: "Admin MA EK MO",
        message: `Le joueur n¬∞${playerIndex} a jou√©.\nR√©sultat : ${choice}`,
        reply_to: "contact@maekmo.com",
      });

      canvas.removeEventListener("mousemove", scratch);
      canvas.removeEventListener("touchmove", scratch);
    }

    document.getElementById("reset-btn").addEventListener("click", () => {
      const pass = prompt("Mot de passe admin :");
      if (pass === "maekmo2025") {
        localStorage.clear();
        alert("‚úÖ Jeu r√©initialis√© !");
        location.reload();
      } else {
        alert("‚ùå Mot de passe incorrect !");
      }
    });

    // Si l‚Äôacc√®s a √©t√© autoris√©, afficher le jeu
    if (localStorage.getItem("accessGranted") === "true") {
      paymentContainer.style.display = "none";
      gameContainer.style.display = "block";
      setup();
    }
  </script>
</body>
</html>
