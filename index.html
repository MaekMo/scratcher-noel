<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>MA EK MO â€“ Jeu de grattage</title>
  <style>
    body{ margin:0; font-family:'Poppins',sans-serif; background:url('Prix2.PNG') center/cover no-repeat fixed; display:flex; align-items:center; justify-content:center; height:100vh; }
    .container{ background:rgba(255,255,255,0.8); border-radius:20px; padding:20px; width:90%; max-width:420px; text-align:center; backdrop-filter:blur(4px); box-shadow:0 0 12px rgba(255,215,0,0.6); position:relative; }
    h1,#player-number{ color:#000; font-weight:600; margin:0; }
    .note { color:#666; font-size:0.95em; margin-top:6px; }
    .pay-area { margin:12px 0; }
    .pay-input { padding:10px; border-radius:8px; border:1px solid #ddd; width:70%; font-size:1em; }
    .pay-btn { background:#d4af37; color:#000; border:none; padding:10px 14px; border-radius:8px; font-weight:700; cursor:pointer; margin-left:8px; }
    canvas{ width:300px; height:160px; border-radius:14px; margin-top:10px; cursor:pointer; box-shadow:0 0 10px rgba(255,215,0,0.8); }
    .video-container{ display:flex; justify-content:center; margin:12px 0; }
    video{ width:220px; border-radius:12px; display:none; }
    .result{ color:#000; position:absolute; width:300px; height:160px; display:flex; align-items:center; justify-content:center; text-align:center; font-size:1.05em; font-weight:700; pointer-events:none; top:120px; left:50%; transform:translateX(-50%); padding:10px; opacity:0; transition:opacity 0.9s ease; }
    .result.visible{ opacity:1; }
    .admin-controls{ margin-top:12px; }
    .admin-controls button{ background:gold; color:black; border:none; padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:bold; margin:4px; }
    .info { color:#666; font-size:0.9em; margin-top:8px; }
    .error { color:#b00; font-weight:700; }
    @media(max-width:600px){ .container{ width:95%; } video{ width:180px; } canvas{ width:260px; height:140px; } .result{ width:260px; height:140px; top:110px; } }
  </style>
</head>
<body>
  <div class="container">
    <h1>MA EK MO â€” Rhums arrangÃ©s & punchs</h1>
    <p class="note">Ticket : <strong>5 â‚¬</strong> â€” un joueur = une participation. Admin : entre le mot de passe pour autoriser le joueur.</p>

    <!-- Admin validation input (entered on the tablet before each player) -->
    <div class="pay-area" id="validationArea">
      <input id="validateInput" class="pay-input" type="password" placeholder="Mot de passe admin pour valider (ex : validate2025)">
      <button id="validateBtn" class="pay-btn">Valider</button>
    </div>

    <p id="player-number">Chargement...</p>

    <div class="video-container">
      <video id="bouchonVideo" src="bouchon2.mp4" muted loop playsinline></video>
    </div>

    <div style="position:relative; display:inline-block;">
      <div id="result" class="result"></div>
      <canvas id="scratchCanvas" width="300" height="160"></canvas>
    </div>

    <div class="admin-controls">
      <button id="reset-local">ðŸ”’ RÃ©initialiser le jeu (local)</button>
      <button id="full-reset">ðŸ”¥ RÃ©initialiser complÃ¨tement (Firestore)</button>
      <button id="open-admin">ðŸ“Š Admin</button>
    </div>

    <p id="statusMsg" class="info"></p>
  </div>

  <!-- EmailJS SDK -->
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
  <script> (function(){ emailjs.init("1P7PupUaqiHbW50OZ"); })(); </script>

  <!-- Firebase + Game logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // Firebase config (identique Ã  ton projet)
    const firebaseConfig = {
      apiKey: "AIzaSyAZcpcC_7l6wYN4SJUGa9dBbEa_ekV1n20",
      authDomain: "ma-ek-mo-grattage.firebaseapp.com",
      projectId: "ma-ek-mo-grattage",
      storageBucket: "ma-ek-mo-grattage.firebasestorage.app",
      messagingSenderId: "478221366203",
      appId: "1:478221366203:web:ffb64fe9cbb7dc0aa20a9e",
      measurementId: "G-BZSKRGV3PS"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // DOM
    const validateInput = document.getElementById("validateInput");
    const validateBtn = document.getElementById("validateBtn");
    const playerNumberEl = document.getElementById("player-number");
    const statusMsg = document.getElementById("statusMsg");
    const scratchCanvas = document.getElementById("scratchCanvas");
    const ctx = scratchCanvas.getContext("2d");
    const resultDiv = document.getElementById("result");
    const video = document.getElementById("bouchonVideo");
    const resetLocalBtn = document.getElementById("reset-local");
    const fullResetBtn = document.getElementById("full-reset");
    const openAdminBtn = document.getElementById("open-admin");

    // Admin passwords
    const VALIDATE_PWD = "validate2025";
    const RESET_PWD = "reset2025";

    // Winners mapping (exact texts)
    const winners = {
      10: "ðŸŽ‰ FÃ©licitations tu as gagnÃ© 1 magnet rum'aide !",
      20: "ðŸŽ‰ FÃ©licitations tu as gagnÃ© 1 verre arum'attisÃ©e!",
      30: "ðŸŽ‰ FÃ©licitations tu as gagnÃ© 1 fiole thym!",
      40: "ðŸŽ‰ FÃ©licitations tu as gagnÃ© 1 magnet arum'attisÃ©e!",
      50: "ðŸŽ‰ FÃ©licitations tu as gagnÃ© 1 verre rum'aide!",
      60: "ðŸŽ‰ FÃ©licitations tu as gagnÃ© 1 fiole citron!",
      70: "ðŸŽ‰ FÃ©licitations tu as gagnÃ© 1 magnet rum'antan !",
      80: "ðŸŽ‰ FÃ©licitations tu as gagnÃ© 1 verre rum'antique !",
      90: "ðŸŽ‰ FÃ©licitations tu as gagnÃ© 1 fiole moringa !",
      100: "ðŸŽ‰ FÃ©licitations tu as gagnÃ© 1 coffret arum'attisÃ©e !",
      110: "ðŸŽ‰ FÃ©licitations tu as gagnÃ© 1 magnet rum'antique !",
      120: "ðŸŽ‰ FÃ©licitations tu as gagnÃ© 1 fiole gingembre !",
      130: "ðŸŽ‰ FÃ©licitations tu as gagnÃ© 1 verre rum'antan!",
      140: "ðŸŽ‰ FÃ©licitations tu as gagnÃ© 1 verre + paille arum'attisÃ©e!",
      150: "ðŸŽ‰ FÃ©licitations tu as gagnÃ© 1 coffret rum'aide !",
      160: "ðŸŽ‰ FÃ©licitations tu as gagnÃ© 1 fiole citronnelle !",
      170: "ðŸŽ‰ FÃ©licitations tu as gagnÃ© 1 verre + paille rum'antique!",
      180: "ðŸŽ‰ FÃ©licitations tu as gagnÃ© 1 fiole cannelle !",
      190: "ðŸŽ‰ FÃ©licitations tu as gagnÃ© 1 verre + paille rum'antan!",
      200: "ðŸŽ‰ FÃ©licitations tu as gagnÃ© 1 coffret rum'antique!"
    };

    const loseMessage = "ðŸ‘ðŸ¾ Bravo tu obtiens une rÃ©duction de -10% dÃ¨s 30â‚¬ d'achat. Offre non cumulable.";
    const MAX_PLAYERS = 200;
    const TICKET_PRICE_EUR = 5;

    // state
    let playerIndex = Number(localStorage.getItem("playerIndex")) || null;
    let hasPlayed = localStorage.getItem("hasPlayed") === "true";
    let deviceValidated = localStorage.getItem("deviceValidated") === "true";
    let revealed = false;

    // Utils
    function showStatus(txt, isError=false) {
      statusMsg.textContent = txt;
      statusMsg.className = isError ? "error" : "info";
    }

    async function getNextPlayerNumber() {
      try {
        const snap = await getDocs(collection(db, "joueurs"));
        return snap.size + 1;
      } catch (err) {
        console.error("getNextPlayerNumber:", err);
        throw err;
      }
    }

    // Validate admin on the tablet before each player
    validateBtn.addEventListener("click", () => {
      const val = (validateInput.value || "").trim();
      if (val === VALIDATE_PWD) {
        deviceValidated = true;
        localStorage.setItem("deviceValidated", "true");
        validateInput.value = "";
        validateInput.disabled = true;
        validateBtn.disabled = true;
        showStatus("âœ… Participation validÃ©e â€” le joueur peut jouer.");
      } else {
        showStatus("âŒ Mot de passe invalide.", true);
      }
    });

    // Setup game
    async function setup() {
      showStatus("Chargement...");
      try {
        // get next player number from firestore (joueurs collection)
        const nextNum = await getNextPlayerNumber();
        if (nextNum > MAX_PLAYERS) {
          playerNumberEl.textContent = "ðŸŽ‰ Jeu terminÃ© â€” 200 joueurs atteints.";
          showStatus("Le quota de 200 joueurs est atteint.");
          return;
        }
        playerIndex = playerIndex || nextNum;
        if (!localStorage.getItem("playerIndex")) localStorage.setItem("playerIndex", playerIndex);
        playerNumberEl.textContent = "Joueur nÂ°" + playerIndex;

        // If already revealed locally show result
        const saved = localStorage.getItem("resultat");
        if (saved) {
          showResult(saved);
          return;
        }

        // draw golden layer
        ctx.clearRect(0,0,scratchCanvas.width,scratchCanvas.height);
        ctx.fillStyle = "#d4af37";
        ctx.fillRect(0,0,scratchCanvas.width,scratchCanvas.height);
        ctx.globalCompositeOperation = "destination-out";

        // attach scratch only if validated for this device
        if (!deviceValidated) {
          showStatus("â³ Attente validation admin (entrez le mot de passe sur la tablette).");
        } else {
          showStatus("ðŸ”“ ValidÃ© â€” le joueur peut gratter.");
        }

        scratchCanvas.addEventListener("mousedown", startScratching);
        scratchCanvas.addEventListener("touchstart", startScratching, {passive:false});
      } catch (err) {
        console.error(err);
        showStatus("Erreur de connexion Ã  la base â€” vÃ©rifier Firestore.", true);
      }
    }

    function startScratching(e) {
      if (!deviceValidated) { showStatus("â— Admin : entrez validate2025 pour autoriser le joueur.", true); return; }
      if (hasPlayed) { showStatus("Vous avez dÃ©jÃ  jouÃ© sur cet appareil.", true); return; }
      revealed = false;
      scratchCanvas.addEventListener("mousemove", scratch);
      scratchCanvas.addEventListener("touchmove", scratch, {passive:false});
      scratchCanvas.addEventListener("mouseup", reveal);
      scratchCanvas.addEventListener("touchend", reveal);
    }

    function scratch(e) {
      e.preventDefault();
      const rect = scratchCanvas.getBoundingClientRect();
      const clientX = (e.touches ? e.touches[0].clientX : e.clientX);
      const clientY = (e.touches ? e.touches[0].clientY : e.clientY);
      const x = clientX - rect.left;
      const y = clientY - rect.top;
      ctx.beginPath();
      ctx.arc(x, y, 15, 0, Math.PI*2);
      ctx.fill();
    }

    async function reveal() {
      if (revealed || hasPlayed) return;
      revealed = true;
      hasPlayed = true;
      localStorage.setItem("hasPlayed","true");

      // Determine result by player index (1..200)
      const choice = winners[playerIndex] || loseMessage;
      showResult(choice);
      localStorage.setItem("resultat", choice);

      // play animation video
      try { video.style.display = "block"; video.play(); } catch(e){ console.warn("video fail",e); }

      // save result in Firestore
      try {
        await addDoc(collection(db, "joueurs"), {
          numero: playerIndex,
          resultat: choice,
          date: new Date().toISOString(),
          paid: true,          // admin validated on device already
          ticketPrice: TICKET_PRICE_EUR
        });
      } catch (err) {
        console.warn("Erreur sauvegarde Firestore:", err);
      }

      // send email to admin
      try {
        emailjs.send("service_cqjooc5","template_ct2ucqj",{
          to_name: "Admin MA EK MO",
          message: `Le joueur nÂ°${playerIndex} a jouÃ©.\nRÃ©sultat : ${choice}`,
          reply_to: "contact@maekmo.com"
        });
      } catch (e) { console.warn("EmailJS error", e); }

      // After a player has played, require admin validation again for next player
      deviceValidated = false;
      localStorage.setItem("deviceValidated","false");
      validateInput.disabled = false;
      validateBtn.disabled = false;
      showStatus("âœ” RÃ©sultat enregistrÃ©. Pour le prochain joueur, entrez Ã  nouveau le mot de passe admin.");
      // increment local playerIndex for next device session (will be recalculated from Firestore on next load)
      localStorage.removeItem("playerIndex");
    }

    function showResult(msg) {
      resultDiv.textContent = msg;
      resultDiv.classList.add("visible");
    }

    // Local reset
    resetLocalBtn.addEventListener("click", () => {
      const pass = prompt("Entrez le mot de passe admin pour rÃ©initialiser localement :");
      if (pass !== RESET_PWD) { alert("Mot de passe incorrect."); return; }
      localStorage.clear();
      alert("âœ… LocalStorage vidÃ©. Recharge la page.");
      location.reload();
    });

    // Full reset (Firestore)
    fullResetBtn.addEventListener("click", async () => {
      const pass = prompt("Entrez le mot de passe pour rÃ©initialiser entiÃ¨rement la base :");
      if (pass !== RESET_PWD) { alert("Mot de passe incorrect."); return; }
      if (!confirm("âš ï¸ Confirmer la suppression de tous les tickets (collection 'joueurs') ?")) return;
      try {
        // delete all docs in 'joueurs'
        const snap = await getDocs(collection(db, "joueurs"));
        for (const d of snap.docs) {
          await deleteDoc(doc(db, "joueurs", d.id));
        }
        localStorage.clear();
        alert("âœ… Base Firestore 'joueurs' vidÃ©e et localStorage effacÃ©.");
        location.reload();
      } catch (err) {
        console.error("Full reset error:", err);
        alert("Erreur lors de la rÃ©initialisation Firestore. Voir console.");
      }
    });

    openAdminBtn.addEventListener("click", () => { window.location.href = "admin.html"; });

    // initialize
    setup();
  </script>
</body>
</html>
