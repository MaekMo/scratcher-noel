<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MA EK MO ‚Äì Jeu de grattage</title>

  <style>
    body {
      margin:0;
      padding:0;
      font-family:'Poppins', sans-serif;
      background:url('Prix2.PNG') center/cover no-repeat fixed;
      display:flex;
      justify-content:center;
      align-items:center;
      height:100vh;
      color:#000;
    }

    .container {
      background:rgba(255,255,255,0.8);
      border-radius:20px;
      padding:20px;
      width:90%;
      max-width:420px;
      text-align:center;
      backdrop-filter:blur(4px);
      box-shadow:0 0 12px rgba(255,215,0,0.6);
    }

    h1 {
      color:#000;
      font-weight:600;
    }

    button {
      background:gold;
      color:black;
      border:none;
      padding:10px 16px;
      border-radius:10px;
      font-weight:bold;
      margin:10px 0;
      cursor:pointer;
      transition:0.2s;
    }

    button:hover {
      transform:scale(1.05);
    }

    .hidden {
      display:none;
    }

    .video-container video {
      width:180px;
      border-radius:12px;
      margin-top:10px;
    }

    canvas {
      width:300px;
      height:160px;
      border-radius:14px;
      margin-top:10px;
      cursor:pointer;
      box-shadow:0 0 10px rgba(255,215,0,0.8);
    }

    .result {
      color:#000;
      position:absolute;
      width:300px;
      height:160px;
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
      font-size:1.1em;
      font-weight:700;
      pointer-events:none;
      top:0;
      left:50%;
      transform:translateX(-50%);
      padding:10px;
      opacity:0;
      transition:opacity 1s ease;
    }

    @media(max-width:600px){
      .container{ width:95%; }
      video{ width:140px; }
      canvas{ width:260px; height:140px; }
      .result{ width:260px; height:140px; }
    }
  </style>
</head>

<body>

  <div class="container" id="start-screen">
    <h1>MA EK MO ‚Äî Rhums arrang√©s & punchs</h1>
    <p>Jeu 100% gagnant !                     Si tu n'as pas gagn√© c'est que tu n'as pas particip√© ! üéÅ<br>Participe pour 2 ‚Ç¨ seulement !</p>

    <button id="pay-wero-btn">üí≥ Payer par Wero</button>
    <button id="already-paid-btn">‚úÖ J‚Äôai d√©j√† pay√©</button>

    <div id="qr-container" class="hidden">
      <p>Scanne ce QR code avec ton app Wero pour payer :</p>
      <img src="qrcode-wero.png" alt="QR Code Wero" width="200" height="200">
      <p><em>Une fois le paiement effectu√©, clique sur ‚ÄúJ‚Äôai d√©j√† pay√©‚Äù.</em></p>
    </div>
  </div>

  <div class="container hidden" id="game-screen">
    <h1>MA EK MO ‚Äî Rhums arrang√©s & punchs</h1>
    <p id="player-number">Chargement...</p>

    <div class="video-container">
      <video id="bouchon-video" src="bouchon2.mp4" muted loop></video>
    </div>

    <div style="position:relative; display:inline-block;">
      <div id="result" class="result"></div>
      <canvas id="scratch-card" width="300" height="160"></canvas>
    </div>

    <button id="reset-btn">üîí R√©initialiser</button>
  </div>

  <!-- üìß EmailJS SDK -->
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
  <script>
    (function() {
      emailjs.init("1P7PupUaqiHbW50OZ");
    })();
  </script>

  <!-- üî• Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAZcpcC_7l6wYN4SJUGa9dBbEa_ekV1n20",
      authDomain: "ma-ek-mo-grattage.firebaseapp.com",
      projectId: "ma-ek-mo-grattage",
      storageBucket: "ma-ek-mo-grattage.firebasestorage.app",
      messagingSenderId: "478221366203",
      appId: "1:478221366203:web:ffb64fe9cbb7dc0aa20a9e",
      measurementId: "G-BZSKRGV3PS"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // S√©lection des √©l√©ments
    const startScreen = document.getElementById("start-screen");
    const gameScreen = document.getElementById("game-screen");
    const payBtn = document.getElementById("pay-wero-btn");
    const alreadyPaidBtn = document.getElementById("already-paid-btn");
    const qrContainer = document.getElementById("qr-container");
    const playerNumber = document.getElementById("player-number");
    const resultDiv = document.getElementById("result");
    const canvas = document.getElementById("scratch-card");
    const ctx = canvas.getContext("2d");
    const video = document.getElementById("bouchon-video");
    const resetBtn = document.getElementById("reset-btn");

    let hasPaid = localStorage.getItem("hasPaid") === "true";
    let hasPlayed = localStorage.getItem("hasPlayed") === "true";
    let revealed = false;

    // -------------------------------
    // üéüÔ∏è PAGE D'ACCUEIL ‚Äî PAIEMENT
    // -------------------------------
    payBtn.addEventListener("click", () => {
      qrContainer.classList.toggle("hidden");
    });

    alreadyPaidBtn.addEventListener("click", () => {
      const pass = prompt("Entrez le mot de passe admin pour confirmation du paiement :");
      if (pass === "maekmo2025") {
        localStorage.setItem("hasPaid", "true");
        alert("‚úÖ Paiement confirm√©. Le jeu est d√©bloqu√© !");
        startScreen.classList.add("hidden");
        gameScreen.classList.remove("hidden");
        setup();
      } else {
        alert("‚ùå Mot de passe incorrect !");
      }
    });

    // -------------------------------
    // üß© LOGIQUE DU JEU DE GRATTAGE
    // -------------------------------
    async function getNextPlayerNumber() {
      const snapshot = await getDocs(collection(db, "joueurs"));
      return snapshot.size + 1;
    }

    async function setup() {
      let playerIndex = localStorage.getItem("playerIndex");
      if (!playerIndex) {
        playerIndex = await getNextPlayerNumber();
        localStorage.setItem("playerIndex", playerIndex);
      }

      playerNumber.textContent = "Joueur n¬∞" + playerIndex;

      const result = localStorage.getItem("resultat");
      if (result) {
        showResult(result);
        return;
      }

      // Zone dor√©e
      ctx.fillStyle = "#d4af37";
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      ctx.globalCompositeOperation = "destination-out";

      canvas.addEventListener("mousedown", startScratching);
      canvas.addEventListener("touchstart", startScratching);
    }

    function startScratching(e) {
      if (hasPlayed || !hasPaid) return;
      revealed = false;
      canvas.addEventListener("mousemove", scratch);
      canvas.addEventListener("touchmove", scratch);
      canvas.addEventListener("mouseup", reveal);
      canvas.addEventListener("touchend", reveal);
    }

    function scratch(e) {
      e.preventDefault();
      const rect = canvas.getBoundingClientRect();
      const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
      const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
      ctx.beginPath();
      ctx.arc(x, y, 15, 0, 2 * Math.PI);
      ctx.fill();
    }

    async function reveal() {
      if (revealed || hasPlayed) return;
      revealed = true;
      hasPlayed = true;
      localStorage.setItem("hasPlayed", "true");

      const isWinner = Math.random() < 5 / 200;
      const choice = isWinner
        ? "üéâ F√©licitations tu as gagn√© !"
        : "üëèüèæ Bravo tu obtiens une r√©duction de -10% d√®s 30‚Ç¨ d'achat.";

      resultDiv.textContent = choice;
      resultDiv.style.opacity = 1;
      localStorage.setItem("resultat", choice);

      video.style.display = "block";
      video.play();

      await addDoc(collection(db, "joueurs"), {
        numero: localStorage.getItem("playerIndex"),
        resultat: choice,
        date: new Date().toISOString(),
      });

      emailjs.send("service_cqjooc5", "template_ct2ucqj", {
        to_name: "Admin MA EK MO",
        message: `Le joueur n¬∞${localStorage.getItem("playerIndex")} a jou√©.\nR√©sultat : ${choice}`,
        reply_to: "contact@maekmo.com",
      });

      canvas.removeEventListener("mousemove", scratch);
      canvas.removeEventListener("touchmove", scratch);
    }

    resetBtn.addEventListener("click", () => {
      const pass = prompt("Mot de passe administrateur :");
      if (pass === "maekmo2025") {
        localStorage.clear();
        alert("‚úÖ Jeu r√©initialis√© !");
        location.reload();
      } else {
        alert("‚ùå Mot de passe incorrect !");
      }
    });
  </script>
</body>
</html>



