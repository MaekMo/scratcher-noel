<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>MA EK MO â€“ Jeu de grattage</title>
  <style>
    body{ margin:0; font-family:'Poppins',sans-serif; background:url('Prix2.PNG') center/cover no-repeat fixed; display:flex; align-items:center; justify-content:center; height:100vh; }
    .container{ background:rgba(255,255,255,0.8); border-radius:20px; padding:20px; width:90%; max-width:420px; text-align:center; backdrop-filter:blur(4px); box-shadow:0 0 12px rgba(255,215,0,0.6); }
    h1,#player-number{ color:#000; font-weight:600; }
    canvas{ width:300px; height:160px; border-radius:14px; margin-top:10px; cursor:pointer; box-shadow:0 0 10px rgba(255,215,0,0.8); }
    .video-container{ display:flex; justify-content:center; margin:10px 0; }
    video{ width:180px; border-radius:10px; display:none; }
    .result{ color:#000; position:absolute; width:300px; height:160px; display:flex; align-items:center; justify-content:center; text-align:center; font-size:1.05em; font-weight:700; pointer-events:none; top:0; left:50%; transform:translateX(-50%); padding:10px; opacity:0; transition:opacity 1s ease; }
    .result.visible{ opacity:1; }
    .admin button{ background:gold; color:black; border:none; padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:bold; margin-top:15px; }
    @media(max-width:600px){ .container{ width:95%; } video{ width:150px; } canvas{ width:260px; height:140px; } .result{ width:260px; height:140px; } }
    .info { margin-top:12px; color:#666; font-size:0.95em; }
    .error { color:#b00; font-weight:700; }
  </style>
</head>
<body>
  <div class="container">
    <h1>MA EK MO â€” Rhums arrangÃ©s & punchs</h1>
    <p id="player-number">Chargement...</p>

    <div class="video-container">
      <video id="bouchon-video" src="bouchon2.mp4" muted loop playsinline></video>
    </div>

    <div style="position:relative; display:inline-block;">
      <div id="result" class="result"></div>
      <canvas id="scratch-card" width="300" height="160"></canvas>
    </div>

    <div class="admin">
      <button id="reset-btn">ðŸ”’ RÃ©initialiser le jeu</button>
    </div>

    <p class="info" id="debug-info"></p>
  </div>

  <!-- EmailJS -->
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
  <script> (function(){ emailjs.init("1P7PupUaqiHbW50OZ"); })(); </script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAZcpcC_7l6wYN4SJUGa9dBbEa_ekV1n20",
      authDomain: "ma-ek-mo-grattage.firebaseapp.com",
      projectId: "ma-ek-mo-grattage",
      storageBucket: "ma-ek-mo-grattage.firebasestorage.app",
      messagingSenderId: "478221366203",
      appId: "1:478221366203:web:ffb64fe9cbb7dc0aa20a9e",
      measurementId: "G-BZSKRGV3PS"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const resultDiv = document.getElementById("result");
    const canvas = document.getElementById("scratch-card");
    const ctx = canvas.getContext("2d");
    const video = document.getElementById("bouchon-video");
    const playerNumber = document.getElementById("player-number");
    const debugInfo = document.getElementById("debug-info");

    let currentPlayerNumber = 0;
    let hasPlayed = localStorage.getItem("hasPlayed") === "true";
    let revealed = false;

    const winners = {
      10: "ðŸŽ‰ FÃ©licitations tu as gagnÃ© 1 magnet rum'aide !",
      20: "ðŸŽ‰ FÃ©licitations tu as gagnÃ© 1 verre arum'attisÃ©e!",
      30: "ðŸŽ‰ FÃ©licitations tu as gagnÃ© 1 fiole thym!",
      40: "ðŸŽ‰ FÃ©licitations tu as gagnÃ© 1 magnet arum'attisÃ©e!",
      50: "ðŸŽ‰ FÃ©licitations tu as gagnÃ© 1 verre rum'aide!",
      60: "ðŸŽ‰ FÃ©licitations tu as gagnÃ© 1 fiole citron!",
      70: "ðŸŽ‰ FÃ©licitations tu as gagnÃ© 1 magnet rum'antan !",
      80: "ðŸŽ‰ FÃ©licitations tu as gagnÃ© 1 verre rum'antique !",
      90: "ðŸŽ‰ FÃ©licitations tu as gagnÃ© 1 fiole moringa !",
      100: "ðŸŽ‰ FÃ©licitations tu as gagnÃ© 1 coffret arum'attisÃ©e !",
      110: "ðŸŽ‰ FÃ©licitations tu as gagnÃ© 1 magnet rum'antique !",
      120: "ðŸŽ‰ FÃ©licitations tu as gagnÃ© 1 fiole gingembre !",
      130: "ðŸŽ‰ FÃ©licitations tu as gagnÃ© 1 verre rum'antan!",
      140: "ðŸŽ‰ FÃ©licitations tu as gagnÃ© 1 verre + paille arum'attisÃ©e!",
      150: "ðŸŽ‰ FÃ©licitations tu as gagnÃ© 1 coffret rum'aide !",
      160: "ðŸŽ‰ FÃ©licitations tu as gagnÃ© 1 fiole citronnelle !",
      170: "ðŸŽ‰ FÃ©licitations tu as gagnÃ© 1 verre + paille rum'antique!",
      180: "ðŸŽ‰ FÃ©licitations tu as gagnÃ© 1 fiole cannelle !",
      190: "ðŸŽ‰ FÃ©licitations tu as gagnÃ© 1 verre + paille rum'antan!",
      200: "ðŸŽ‰ FÃ©licitations tu as gagnÃ© 1 coffret rum'antique!"
    };
    const loseMessage = "ðŸ‘ðŸ¾ Bravo tu obtiens une rÃ©duction de -10% dÃ¨s 30â‚¬ d'achat. Offre non cumulable.";

    async function setup() {
      try {
        // try joueurs first, fallback to players
        let docs = await getDocs(collection(db, "joueurs"));
        if (!docs || docs.empty) {
          // try alternative collection name
          docs = await getDocs(collection(db, "players"));
        }
        currentPlayerNumber = (docs && docs.size) ? docs.size + 1 : 1;

        if (currentPlayerNumber > 200) {
          playerNumber.textContent = "ðŸŽ‰ Jeu terminÃ© ! 200 joueurs atteints.";
          return;
        }
        playerNumber.textContent = "Joueur nÂ°" + currentPlayerNumber;

        // draw golden layer only if no saved result
        const saved = localStorage.getItem("resultat");
        if (saved) {
          showResult(saved);
          return;
        }

        // fill golden layer
        ctx.clearRect(0,0,canvas.width,canvas.height);
        ctx.fillStyle = "#d4af37";
        ctx.fillRect(0,0,canvas.width,canvas.height);
        ctx.globalCompositeOperation = "destination-out";

        canvas.addEventListener("mousedown", startScratching);
        canvas.addEventListener("touchstart", startScratching, {passive:false});
      } catch (err) {
        console.error("Setup error:", err);
        debugInfo.innerHTML = "<span class='error'>Erreur de connexion Ã  la base : vÃ©rifier Firestore et la console.</span>";
        playerNumber.textContent = "Erreur de chargement";
      }
    }

    function startScratching(e) {
      if (hasPlayed) return;
      revealed = false;
      canvas.addEventListener("mousemove", scratch);
      canvas.addEventListener("touchmove", scratch, {passive:false});
      canvas.addEventListener("mouseup", reveal);
      canvas.addEventListener("touchend", reveal);
    }

    function scratch(e) {
      e.preventDefault();
      const rect = canvas.getBoundingClientRect();
      const clientX = (e.touches ? e.touches[0].clientX : e.clientX);
      const clientY = (e.touches ? e.touches[0].clientY : e.clientY);
      const x = clientX - rect.left;
      const y = clientY - rect.top;
      ctx.beginPath();
      ctx.arc(x, y, 15, 0, Math.PI*2);
      ctx.fill();
    }

    async function reveal() {
      if (revealed || hasPlayed) return;
      revealed = true;
      hasPlayed = true;
      localStorage.setItem("hasPlayed","true");

      const choice = winners[currentPlayerNumber] ?? loseMessage;
      showResult(choice);
      localStorage.setItem("resultat", choice);

      try {
        video.style.display = "block";
        video.play();
      } catch(e){ console.warn("video play failed", e); }

      try {
        await addDoc(collection(db, "joueurs"), {
          numero: currentPlayerNumber,
          resultat: choice,
          date: new Date().toISOString()
        });
      } catch (err) {
        console.warn("Erreur addDoc:", err);
      }

      try {
        emailjs.send("service_cqjooc5","template_ct2ucqj",{
          to_name:"Admin MA EK MO",
          message:`Le joueur nÂ°${currentPlayerNumber} a jouÃ©.\nRÃ©sultat : ${choice}`,
          reply_to:"contact@maekmo.com"
        });
      } catch(e){ console.warn("EmailJS send failed", e); }
    }

    function showResult(msg) {
      resultDiv.textContent = msg;
      resultDiv.classList.add("visible");
    }

    document.getElementById("reset-btn").addEventListener("click", async () => {
      const pass = prompt("Mot de passe admin ðŸ”:");
      if (pass !== "maekmo2025") { alert("âŒ Mot de passe incorrect."); return; }
      try {
        // delete collection 'joueurs' documents
        const docs = await getDocs(collection(db, "joueurs"));
        docs.forEach(async d => { try { await deleteDoc(doc(db, "joueurs", d.id)); } catch(e){} });
      } catch(e){}
      localStorage.clear();
      alert("ðŸ”¥ Jeu rÃ©initialisÃ© !");
      location.reload();
    });

    // start
    setup();
  </script>
</body>
</html>