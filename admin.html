<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>MA EK MO ‚Äî Administration</title>
  <style>
    body{ margin:0; font-family:'Poppins',sans-serif; background:url('Prix2.PNG') center/cover no-repeat fixed; padding:20px; display:flex; justify-content:center; }
    .card{ width:95%; max-width:1100px; background:rgba(255,255,255,0.9); border-radius:14px; padding:18px; box-shadow:0 10px 30px rgba(0,0,0,0.08); }
    h1{ margin:0 0 8px 0; }
    .controls{ display:flex; gap:10px; align-items:center; margin-bottom:12px; flex-wrap:wrap; }
    input[type=password]{ padding:8px; border-radius:8px; border:1px solid #ddd; }
    button{ padding:8px 12px; border-radius:8px; border:0; font-weight:700; cursor:pointer; }
    .btn-gold{ background:#d4af37; color:#000; }
    .btn-danger{ background:#d9534f; color:#fff; }
    .btn-muted{ background:#f0f0f0; color:#000; }
    table{ width:100%; border-collapse:collapse; font-size:14px; margin-top:12px; }
    th, td{ padding:10px; border-bottom:1px solid #eee; text-align:left; }
    th{ background:linear-gradient(180deg, rgba(212,175,55,0.14), transparent); }
    .actions{ text-align:right; }
    .small{ font-size:0.9em; color:#666; }
    @media(max-width:900px){ .actions{ text-align:left; } }
  </style>
</head>
<body>
  <div class="card">
    <h1>MA EK MO ‚Äî Panneau Admin</h1>
    <p class="small">Acc√®s prot√©g√© ‚Äî mot de passe pour r√©initialisation : <strong>reset2025</strong>. Pour valider un joueur : <strong>validate2025</strong>.</p>

    <div class="controls">
      <input id="adminPwd" type="password" placeholder="Mot de passe admin (reset)"/>
      <button id="loginBtn" class="btn-gold">Se connecter</button>
      <button id="refreshBtn" class="btn-muted">üîÑ Rafra√Æchir</button>
      <button id="exportBtn" class="btn-muted">üì• Export CSV</button>
      <button id="cleanupBtn" class="btn-danger">üß® R√©initialiser Firestore</button>
    </div>

    <div id="panel" style="display:none;">
      <div style="margin-bottom:10px;">
        <strong>Total joueurs :</strong> <span id="totalPlayers">0</span>
        &nbsp; ‚Ä¢ &nbsp; <strong>Gagnants :</strong> <span id="winnersCount">0</span>
        &nbsp; ‚Ä¢ &nbsp; <strong>Gagnants restants :</strong> <span id="winnersLeft">20</span>
        &nbsp; ‚Ä¢ &nbsp; <strong>Prochain gagnant :</strong> <span id="nextWinner">10</span>
      </div>

      <table>
        <thead><tr><th>#</th><th>Nom/ID</th><th>R√©sultat</th><th>Date</th><th>Pay√©</th><th>Statut</th><th class="actions">Actions</th></tr></thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, getDocs, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAZcpcC_7l6wYN4SJUGa9dBbEa_ekV1n20",
      authDomain: "ma-ek-mo-grattage.firebaseapp.com",
      projectId: "ma-ek-mo-grattage",
      storageBucket: "ma-ek-mo-grattage.firebasestorage.app",
      messagingSenderId: "478221366203",
      appId: "1:478221366203:web:ffb64fe9cbb7dc0aa20a9e",
      measurementId: "G-BZSKRGV3PS"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const RESET_PWD = "reset2025";
    const VALIDATE_PWD = "validate2025";

    const adminPwd = document.getElementById("adminPwd");
    const loginBtn = document.getElementById("loginBtn");
    const panel = document.getElementById("panel");
    const tbody = document.getElementById("tbody");
    const totalPlayers = document.getElementById("totalPlayers");
    const winnersCount = document.getElementById("winnersCount");
    const winnersLeft = document.getElementById("winnersLeft");
    const nextWinner = document.getElementById("nextWinner");
    const refreshBtn = document.getElementById("refreshBtn");
    const exportBtn = document.getElementById("exportBtn");
    const cleanupBtn = document.getElementById("cleanupBtn");

    let logged = false;
    let currentList = [];

    function isWinnerText(text) { return text && /f√©licitations|f√©licitation/i.test(text); }
    function computeNext(total) { if (total >= 200) return "‚Äî"; return Math.min(200, Math.ceil((total+1)/10)*10); }

    async function loadPlayers() {
      tbody.innerHTML = "<tr><td colspan='7'>Chargement‚Ä¶</td></tr>";
      try {
        let snaps = await getDocs(collection(db, "joueurs"));
        let rows = snaps.docs.map(d => ({ id:d.id, ...d.data() }));
        if (!rows.length) { 
          const snaps2 = await getDocs(collection(db,"players"));
          rows = snaps2.docs.map(d=>({ id:d.id, ...d.data() }));
        }

        // normalize & sort
        rows.sort((a,b) => {
          const na = Number(a.numero) || 0;
          const nb = Number(b.numero) || 0;
          if (na && nb) return na - nb;
          const da = a.date ? new Date(a.date).getTime() : 0;
          const dbv = b.date ? new Date(b.date).getTime() : 0;
          return da - dbv;
        });

        currentList = rows;
        renderTable(rows);
      } catch (err) {
        console.error(err);
        tbody.innerHTML = "<tr><td colspan='7'>Erreur Firestore ‚Äî v√©rifier la console.</td></tr>";
      }
    }

    function renderTable(list) {
      if (!list.length) {
        tbody.innerHTML = "<tr><td colspan='7'>Aucun joueur</td></tr>";
        totalPlayers.textContent = 0;
        winnersCount.textContent = 0;
        winnersLeft.textContent = 20;
        nextWinner.textContent = 10;
        return;
      }
      let winners = 0;
      tbody.innerHTML = "";
      list.forEach((p, idx) => {
        const num = p.numero ?? (idx+1);
        const win = isWinnerText(p.resultat);
        if (win) winners++;
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${num}</td>
          <td>${p.name ?? p.nom ?? p.id ?? "-"}</td>
          <td>${p.resultat ?? "-"}</td>
          <td>${p.date ? new Date(p.date).toLocaleString() : "-"}</td>
          <td>${p.paid || p.paye ? "‚úÖ" : "‚ùå"}</td>
          <td>${p.status ?? (p.paid||p.paye ? "validated" : "pending")}</td>
          <td class="actions">
            <button class="btn-gold" data-id="${p.id}" data-num="${num}" onclick="validatePlayer(event)">Valider</button>
            <button class="btn-muted" data-id="${p.id}" onclick="deletePlayer(event)">Supprimer</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
      totalPlayers.textContent = list.length;
      winnersCount.textContent = winners;
      winnersLeft.textContent = Math.max(0, 20 - winners);
      nextWinner.textContent = computeNext(list.length);
    }

    window.validatePlayer = async function(e) {
      if (!logged) return alert("Connecte-toi d'abord.");
      const btn = e.currentTarget;
      const id = btn.dataset.id;
      const numero = btn.dataset.num;
      const pwd = prompt("Mot de passe pour valider ce paiement :");
      if (pwd !== VALIDATE_PWD) return alert("Mot de passe invalide.");
      try {
        await updateDoc(doc(db, "joueurs", id), { paye:true, status:"validated", validatedAt: new Date().toISOString() }).catch(()=>{});
        await updateDoc(doc(db, "players", id), { paid:true, status:"validated", validatedAt: new Date().toISOString() }).catch(()=>{});
        alert("Paiement valid√© pour le joueur " + numero);
        await loadPlayers();
      } catch (err) { console.error(err); alert("Erreur validation."); }
    };

    window.deletePlayer = async function(e) {
      if (!logged) return alert("Connecte-toi d'abord.");
      const id = e.currentTarget.dataset.id;
      if (!confirm("Supprimer ce joueur ?")) return;
      try {
        await deleteDoc(doc(db,"joueurs",id)).catch(()=>{});
        await deleteDoc(doc(db,"players",id)).catch(()=>{});
        alert("Supprim√©.");
        await loadPlayers();
      } catch (err) { console.error(err); alert("Erreur suppression."); }
    };

    loginBtn.addEventListener("click", async () => {
      const val = adminPwd.value.trim() || prompt("Mot de passe admin (reset) :");
      if (val !== RESET_PWD) { alert("Mot de passe incorrect."); adminPwd.value=""; return; }
      logged = true;
      adminPwd.value = "";
      panel.style.display = "block";
      await loadPlayers();
    });

    refreshBtn.addEventListener("click", async () => { if (!logged) return alert("Connecte-toi d'abord."); await loadPlayers(); });

    exportBtn.addEventListener("click", () => {
      if (!logged) return alert("Connecte-toi d'abord.");
      if (!currentList || !currentList.length) return alert("Rien √† exporter");
      const headers = ["numero","name","resultat","date","paid","status","id"];
      const lines = [headers.join(",")];
      currentList.forEach(r => {
        lines.push(headers.map(h => `"${(r[h]??"").toString().replace(/\"/g,'""')}"`).join(","));
      });
      const blob = new Blob([lines.join("\n")], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a"); a.href = url; a.download = "maekmo_players.csv"; a.click(); URL.revokeObjectURL(url);
    });

    cleanupBtn.addEventListener("click", async () => {
      if (!logged) return alert("Connecte-toi d'abord.");
      const pwd = prompt("Mot de passe reset :");
      if (pwd !== RESET_PWD) return alert("Mot de passe reset invalide.");
      if (!confirm("Confirmer suppression collections joueurs, players, payments, game_state ?")) return;
      try {
        const cols = ["joueurs","players","payments","game_state"];
        for (const c of cols) {
          const snaps = await getDocs(collection(db,c));
          for (const d of snaps.docs) { await deleteDoc(doc(db,c,d.id)); }
        }
        alert("Firestore r√©initialis√©.");
        await loadPlayers();
      } catch (err) { console.error(err); alert("Erreur reset: "+err.message); }
    });

  </script>
</body>
</html>
